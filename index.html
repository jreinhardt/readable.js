<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript"></script>
		<script src="readable.js" type="text/javascript"></script>
		<script src="http://d3js.org/d3.v2.js"></script>

		<script type="text/javascript">

			function TextInfo(name,grades){
				var res = {};
				res.name = name;
				if(grades === undefined){
					res.grades = Array(metrics.length);
				} else {
					res.grades = grades;
				}
				res.getMaximumGrade = function(){return Math.max.apply(res.grades)/res.grades.length;};
				res.getMinimumGrade = function(){return Math.min.apply(res.grades)/res.grades.length;};
				res.getAverageGrade = function(){return res.grades.reduce(function(a,b){return a+b;},0)/res.grades.length;};
				return res;
			};

			REFERENCES = [
				TextInfo('Declaration of Independence',[12.0, 13.9, 14.9, 13.3]),
				TextInfo('Alice in Wonderland', [5.7, 6.0, 8.6, 7.7]),
				TextInfo('I have a Dream', [8.0, 8.3, 11.2, 10.6]),
				TextInfo('Critique of pure Reason', [11.7, 12.8, 14.6, 13.3]),
				TextInfo('Typical "The Sun" Article', [6.7, 5.0, 8.0, 8.5])
			];

			SCALE = [
				{at: 3, name: "easy"},
				{at: 17, name: "difficult"}
			];

			var metrics = [
				{name: 'ColemanLiau',
					score: function(text) {return text.getColemanLiauIndex()},
					descr: "The Coleman-Liau index depends on the length of the words and the number of words per sentence. Lower values indicate a better readability.",
					link: "http://en.wikipedia.org/wiki/Coleman-Liau_index"},
				{name: 'AutomatedReadability',
					score: function(text) {return text.getAutomatedReadabilityIndex()},
					descr: "The Automated Readability Index depends on length of the words and the number of words per sentence. Lower values indicate a better readability.",
					link: "http://en.wikipedia.org/wiki/Automated_Readability_Index"},
				{name: 'GunningFog',
					score: function(text) {return text.getGunningFogIndex()},
					descr: "The Gunning-Fog index depends on the number of words per sentence and the number of complex words. Lower values indicate a better readability.",
					link: "http://en.wikipedia.org/wiki/Gunning-Fog_Index"},
				{name: 'SMOG',
					score: function(text) {return text.getSmogGrade()},
					descr: "The SMOG grade depends on the number of complex words per sentence. Lower values indicate a better readability.",
					link: "http://en.wikipedia.org/wiki/SMOG"}
			];
			/*
			Auto-update with typing time-out.
			*/
			var autoUpdateTimer;
			var AUTO_UPDATE_TIMEOUT = 500; // in ms
			var data;

			/* Find the idx for entry for a text in data from the texts name */
			function findIdx(data,name){
				for(var i=0;i<data.length;i++){
					if(data[i].name == name){
						return i;
					}
				}
				return -1;
			}

			function compareTexts(a,b) {
				if(a.getAverageGrade() < b.getAverageGrade()){
					return -1;
				}
				return 1;
			}

			$(document).ready(function() {

				//Prepare Description
				var legend = d3.selectAll('#legend');
				legend.selectAll("div").data(metrics).enter().append("div").attr("class","description");
				legend.selectAll("div.description").data(metrics)
					.append("h2")
					.attr("class",function(d,i){return d.name;})
					.text(function(d,i){return d.name;});
				legend.selectAll("div.description").data(metrics)
					.append("div")
					.text(function(d,i){return d.descr;});
				legend.selectAll("div.description").data(metrics)
					.append("a")
					.attr("href",function(d,i){return d.link;})
					.text("Read more");

				//Prepare chart
				var chart = d3.select('#results').append("svg").attr("height",(REFERENCES.length+3)*20).attr("width",600).attr("class","chart");

				data = REFERENCES.concat([TextInfo("Your Text",[0,0,0,0])]);
				data.sort(compareTexts);

				for(var j=0;j<metrics.length;j++){
					chart.selectAll("rect."+metrics[j].name).data(data, function(d){return d.name;})
						.enter().append("rect")
						.attr("class",metrics[j].name)
						.attr("x", function(d,i) {return  Math.max(1,d.grades[j]*20)})
						.attr("y", function(d,i) {return 20*i})
						.attr("width", function(d,i) {return 4})
						.attr("height", function(d,i) {return 18});
				}
				//Text name
				chart.selectAll("text.label").data(data)
					.enter().append("text")
					.attr("class","label")
					.attr("x", function(d,i) {return 600})
					.attr("y", function(d,i) {return 20*(i+1)-2})
					.attr("text-anchor","end").text(function(d,i) {return d.name});

				//Scale
				chart.selectAll("text.scale").data(SCALE)
					.enter().append("text")
					.attr("class","scale")
					.attr("x", function(d,i) {return 20*d.at;})
					.attr("y", function(d,i) {return 150})
					.attr("text-anchor","middle").text(function(d,i) {return d.name});

				//Prepare update timer
				$('#text').on('input paste', function() {
					clearTimeout(autoUpdateTimer);
					if ($('#text').val) {
						autoUpdateTimer = setTimeout(update, AUTO_UPDATE_TIMEOUT);
					}
				});
			});

			function update(evt) {
				var grades = Array(metrics.length);
				if(document.form.text.value.length === 0){
					for(var i=0;i<metrics.length;i++){
						grades[i] = 0;
					}
				} else {
					var text = Text(document.form.text.value);
					for(var i=0;i<metrics.length;i++){
						grades[i] = metrics[i].score(text);
					}
				}
				data = REFERENCES.concat([TextInfo("Your Text",grades)]);

				data.sort(compareTexts);

				var chart = d3.select('#results').select("svg")

				for(var j=0;j<metrics.length;j++){
					(function(j){
						chart.selectAll("rect."+metrics[j].name).data(data, function(d){return d.name;})
							.transition().duration(500)
							.attr("x", function(d,i) {return  Math.max(1,d.grades[j]*20)})
							.attr("y", function(d,i) {return 20*i});
					})(j);
				}

				//Text name
				chart.selectAll("text.label").data(data, function(d){return d.name;})
					.transition().duration(500)
					.attr("x", function(d,i) {return 600})
					.attr("y", function(d,i) {return 20*(i+1)-2})
					.attr("text-anchor","end").text(function(d,i) {return d.name});
			}

		</script>

		<style type="text/css">

			#content {
				width:600px;
				margin:0 auto 0 auto;
			}

			.ColemanLiau{
				stroke: #5F18A5;
				fill: #5F18A5;
				color: #5F18A5;
			}

			.SMOG{
				stroke: #E72621;
				fill: #E72621;
				color: #E72621;
			}

			.AutomatedReadability{
				stroke: #F6811B;
				fill: #F6811B;
				color: #F6811B;
			}

			.GunningFog{
				stroke: #4ED8F8;
				fill: #4ED8F8;
				color: #4ED8F8;
			}

			svg.chart text{
				fill: black;
			}

			svg.chart rect{
				opacity: 0.5;
			}
		</style>
	</head>

	<body>

		<div id="content">

			<h1>readable.js</h1>

			<p><i>readable.js</i> is a Javascript library for
			readability analysis. Get it <a href="http://www.github.com/jreinhardt/readable.js">on github</a>.</p>

			<h2>Try it now!</h2>
			<p>Type or paste a text and see how readable it is compared to other
			texts:</p>
			<form name="form">
				<textarea name="text" id="text" cols="80" rows="10"></textarea>
			</form>

			<div id="results"></div>
			<div id="legend"></div>
		</div>

		<!-- Javascript support check -->
		<div id="no_javascript" style="border:1px solid #f00;">This site requires JavaScript. Please enable JavaScript-support in your browser.</div>
		<script type="text/javascript">
			element = document.getElementById("no_javascript");
			element.parentNode.removeChild(element);
			$('#content').show();
		</script>

	</body>
</html>
